<?xml version="1.0" encoding="utf-8" ?>
<book ns="http://www.oasis-open.org/docbook/xml/4.1.2/docbookx.dtd" id="openct">
	<title>OpenCT Manual</title>
	<bookinfo>
		<author>
			<firstname>Andreas</firstname>
			<surname>Jellinghaus</surname>
			<email>aj@dungeon.inka.de</email>
		</author>
	</bookinfo>

	<toc />

	<chapter id="openct.about">
		<title>About OpenCT</title>

		<para>
			This is OpenCT, a middleware framework for smart card
			terminals.
		</para>

		<para>
			It all started with a reader driver library - Olaf
			wanted to write a library to provide a framework for
			people writing drivers for smart card readers. The idea
			was to provide all the usual stuff (T=0, T=1, serial
			vs. USB device handling, etc) in a single place, and
			reduce driver writing to interaction with the device
			itself. 
		</para>

		<para>
			Olaf added interface bindings for CT-API and PC/SC, both
			of which are broken at the moment because he ended up
			writing my own resource manager.
		</para>
		

		<para>
			OpenCT is an open source implementation providing card
			terminal drivers. OpenCT was written by Olaf Kirch
			<email>okir@suse.de</email> with contributions
			from the following people:
		</para>

		<itemizedlist>
			<listitem>
				 The checksum code for T=1 (src/ifd/checksum.c)
				 was taken from Matthias Bruestle's excellent
				 SCEZ library.
			</listitem>

			<listitem>
				The e-gate driver was contributed, and is
				copyright by, Chaskiel Grundman
				<email>cg2v@andrew.cmu.edu</email>
			</listitem>

			<listitem>
				 The eToken driver is loosely based on code
				 written by Andreas Jellinghaus
				 <email>aj@dungeon.inka.de</email>
				 (the ikey3k and eutron driver, too,
				 and most of the documentation)
			 </listitem>

			 <listitem>
				 Markus Friedl helped with the *BSD port.
			 </listitem>

			 <listitem>
				 Thanks to Ville Skytt√§ for help with
				 the documentation.
			 </listitem>
		</itemizedlist>

		<para>
			OpenCT provides CT-API drivers, ifdhandler drivers
			as well as it's own resource manager for direct
			use by applications.
		</para>
	</chapter>

	<chapter id="openct.copyright">
		<title>Copyright and license</title>

		<para>
			Most of OpenCT is copyright by Olaf Kirch
			<email>okir@suse.de</email>, but see every
			source file for the individual authors.
		</para>

		<para>
			FIXME: Olaf should really assign some license
			to the whole think. I vote for LGPL or BSD
			license (or both). 
		</para>
	</chapter>

	<chapter id="openct.supported">
		<title>Supported readers and tokens</title>

		<variablelist>
			<varlistentry>
				<term><ulink url="http://www.towitoko.de/hpeng/prod_micro.htm">Towitoko CHIPDRIVE micro</ulink></term>
				<listitem>
					A cheap and very popular smart card
					reader for the serial interfaces
					manufactured by
					<ulink url="http://www.towitoko.de/">
					Towitoko AG</ulink>. Fully supported.
				</listitem>
			</varlistentry>

			<varlistentry>
				<term><ulink url="http://www.kobil.de/e/index.php?s=smartcard">KOBIL KAAN Professional</ulink></term>
				<listitem>
					A smart card reader by <ulink
					url="http://www.kobil.de/indexe.html">
					KOBIL Systems</ulink>
					for the serial interfaces. Fully supported.
				</listitem>
			</varlistentry>

			<varlistentry>
				<term><ulink url="http://www.readers.slb.com/Products/e-gate/e-gate.html">Schlumberger e-gate</ulink></term>
				<listitem>
					A USB token / smart card reader from
					<ulink url="http://www.readers.slb.com/">Schlumberger</ulink>.
					It was only tested with
					Schlumberger cyberflex 32k cards.
					FIXME: I don't know if that adapter
					should work with other cards as well.
				</listitem>
			</varlistentry>

			<varlistentry>
				<term><ulink url="http://www.ealaddin.com/etoken/PRO/">Aladdin eToken PRO</ulink></term>
				<listitem>
					A USB crypto Token by <ulink
					url="http://www.ealaddin.com/">
					Aladdin Knowledge Systems</ulink>.
					Some older versions could have problems
					with non-Intel mainboards. Except for
					that issue: Fully supported.
				</listitem>
			</varlistentry>

			<varlistentry>
				<term><ulink url="http://www.cryptoidentity.eutron.com/">Eutron CryptoIdentity IT-SEC</ulink></term>
				<listitem>
					A USB crypto Token by <ulink
					url="http://www.eutron.com/">Eutron</ulink>.
					Fully supported.
				</listitem>
			</varlistentry>

			<varlistentry>
				<term><ulink url="http://www.rainbow.com/products/ikey/">Rainbow iKey 3000</ulink></term>
				<listitem>
					A USB crypto Token by <ulink
					url="http://www.rainbow.com/">
					Rainbow Technologies</ulink>.
					Fully supported.
				</listitem>
			</varlistentry>

			<varlistentry>
				<term><ulink url="http://www.omnikey.com/en/kat_smartcard.php3">OMNIKEY CardMan</ulink></term>
				<listitem>
					A USB smart card reader? Supported?
					FIXME: I have no idea.
				</listitem>
			</varlistentry>
		</variablelist>
	</chapter>


	<chapter id="openct.requirements">
		<title>Requirements</title>

		<para>
			To use OpenCT with smart card readers attached to
			the serial port, you only need a kernel with
			a working serial port, nothing special is required.
		</para>

		<para>
			To use OpenCT with smart card readers attached
			via USB you need a bit more: your kernel needs
			to support USB and your kernel needs to support
			the USB controller you are using. On most computers
			the USB controller is part of the mainboard. If
			your mainboard uses Intel chips you need most
			likely the "uhci" USB controller support, for
			other vendors most likely the "ohci" controller support.
		</para>

		<para>
			FIXME: I'd like to link to some USB howto with all
			the details and more help. Is there such a HOWTO?
		</para>

		<para>
			You also need to compile your kernel with support for
			the USB device filesystem and mount the filesystem
			to <filename>/proc/bus/usb</filename>. The kernel
			option is CONFIG_USB_DEVICEFS, please turn it on.
			To mount the filesystem, please edit your
			<filename>/etc/fstab</filename>. For a Linux kernel
			2.4.* system, it should have a line
			<screen>
none	/proc/bus/usb	usbdevfs	defaults	0	0
			</screen>
			and for a Linux kernel 2.5.* or 2.6.* system, it should have a line:
			<screen>
none	/proc/bus/usb	usbfs		defaults	0	0
			</screen>
		</para>

		<para>
			Run <prompt>mount -a </prompt> after editing the
			file <filename>/etc/fstab</filename> for the changes
			to take effect. You can also reboot. If you are using
			sometimes Linux kernels 2.4.* and sometimes
			2.5.*/2.6.*, use the line for kernel 2.4.*. You will
			get a warning, but it will still work.
		</para>

		<para>
			Your kernel also needs to be compiled with hotplugging
			support. The relevant kernel option is CONFIG_HOTPLUG.
			You don't need any of the hardware adapters.
		</para>
	</chapter>

	<chapter id="openct.install">
		<title>Installation</title>

		<para>
			First, you need to build the OpenCT libraries
			and utilities. You do this by first invoking
			the configure script, for instance
			<screen>
$ ./configure --prefix=/usr --sysconfdir=/etc
			</screen>
		</para>

		<para>
			This will try configure OpenCT so it is
			installed below <filename>/usr</filename>,
			and so that it expects its configuration
			file <filename>/etc</filename>. If you omit
			the "--sysconfdir" option, OpenCT will
			look for the configuration file in
			<filename>$PREFIX/etc</filename>.
		</para>

		<para>
			Next, you need to compile and install
			all libraries and utilities using
			<screen>
$ make
$ make install
			</screen>
		</para>

		<para>
			Once that has completed, create the directory
			<filename>/var/run/openct</filename> and set the
			permissions. Do this with the commands:
			<screen>
$ mkdir /var/run/openct
$ chmod 755 /var/run/openct
			</screen>
		</para>

		<para>
			These default permissions will allow everyone
			on your system to use smart card readers
			available via OpenCT. For details and a more
			restrictive setup, please consult the
			<link linkend="openct.security">chapter
			on Security</link>.
		</para>

		<para>
			Next, you need the configuration file
			<filename>openct.conf</filename>.
			The exact location of the file depends
			on how you invoked the
			<filename>configure</filename> script, but
			using the options shown above, the file
			should go to <filename>/etc</filename>:
			<screen>
$ cp etc/openct.conf /etc/
			</screen>
		</para>

		<para>
			You need to edit the config file for any serial
			reader you might have. If you are only using
			USB tokens, the default file is already fine.
		</para>

		<para>
			Third you need an init script to perform some
			operations on startup and shutdown. OpenCT
			ships with an init script that should work
			at least on Debian systems.
			Install the script by copying it from the
			source directory:
			<screen>
$ cp etc/init-script /etc/init.d/openct
			</screen>
		</para>


		<para>
			Now configure your runlevels to start the init
			script every time the system boots, and to stop
			the init script every time the system shuts down.
			Use whatever your distribution provides or a
			GUI tool like the KDE runlevel editor.
		</para>

		<para>
			Debian users can do this with a single command:
			<screen>
$ update-rc.d openct start 90 2 3 4 5 . stop 10 0 1 6 .
			</screen>
		</para>

		<para>
			Call the init script once with "start".
			Or reboot. :-)
			<screen>
$ /etc/init.d/openct start
			</screen>
		</para>

		<para>
			And now the last task: if you want to use
			USB readers or USB crypto tokens, you need
			to configure the hotplug system to call
			openct every time there is a new smart
			card reader or crypto token.
		</para>

		<section id="openct.install.withouthp">
			<title>Installation without hotplug utils</title>

		<para>
			This section applies, if your system does
			not have hotplug utils installed. If this command
			succeeds, go to the other section:
			<screen>
$ ls /sbin/hotplug
			</screen>
		</para>

		<para>
			If there is no such file, the installation
			is very easy: 
			<screen>
ln -s /path/to/openct/sbin/hotplug.openct /sbin/hotplug
			</screen>
		</para>

		<para>
			Now attach some USB smart card reader or USB crypto
			token. The kernel will start
			<filename>/sbin/hotplug</filename>, and 
			<prompt>openct-tool list</prompt>
			should list the new reader.
		</para>

	</section>

	<section id="openct.install.withhp">
		<title>Installation with hotplug utils</title>

		<para>
			First the general instructions, then the Debian
			specific instructions. As usual Debian does everything
			a bit different. That doesn't mean it is necessarily
			better or worse.
		</para>

		<para>
			Edit <filename>/etc/hotplug/usb.usermap</filename> and
			add these lines:
			<screen>
openct 0x0003 0x0973 0x0001 0x0000 0x0001 0xff 0x00 0x00 0xff 0x00 0x00 0x0000 0000
openct 0x0003 0x0529 0x050c 0x0000 0x0001 0xff 0x00 0x00 0xff 0x00 0x00 0x0000 0000
openct 0x0003 0x0529 0x0514 0x0000 0x0001 0xff 0x00 0x00 0xff 0x00 0x00 0x0000 0000
openct 0x0003 0x073d 0x0005 0x0000 0x0001 0xff 0x00 0x00 0xff 0x00 0x00 0x0000 0000
openct 0x0003 0x04b9 0x1300 0x0000 0x0001 0xff 0x00 0x00 0xff 0x00 0x00 0x0000 0000
openct 0x0003 0x076b 0x0596 0x0000 0x0001 0xff 0x00 0x00 0xff 0x00 0x00 0x0000 0000
			</screen>
		</para>

		<para>
			Create the directory
			<filename>/etc/hotplug/usb</filename> and add a symlink
			"openct" to hotplug.openct.
			<screen>
mkdir /etc/hotplug/usb
ln -s /path/to/openct/sbin/hotplug.openct /etc/hotplug/usb/openct
			</screen>
		</para>
	</section>

	</chapter>

	<chapter id="openct.debug">
		<title>Debugging</title>

		<para>
			Edit <filename>openct.conf</filename>
			and set debug to 4.
		</para>

		<para>
			If the problem is with some USB crypto token
			(e.g. Aladdin eToken PRO), please grep for
			usb_control - these are the lines I need
			to see what is happening (or not working).
		</para>

	</chapter>
	
	<chapter id="openct.files">
		<title>OpenCT files and tools</title>

		<para>
			This chapter will list all tools and files and
			explain what they do.
		</para>

		<section id="openct.files.varrunopenct">
			<title>/var/run/openct - OpenCT status directory</title>

			<para>
				This directory holds status files for OpenCT.
				Create it with: <screen>
mkdir /var/run/openct
chmod 755 /var/run/openct
				</screen>
			</para>
			
			<para>
				By default everyone can use smart cards via
				OpenCT. You can create a group "openct", assign
				users to that group, and limit access to 
				smart cards via openct like this:
				<screen>
chgrp openct /var/run/openct
chmod 750 /var/run/openct
				</screen>
			</para>
		</section>

		<section id="openct.files.sbinopenctcontrol">
			<title>sbin/openct-control - OpenCT manager</title>

			<para>
				Run openct-control once to setup the
				<filename>status</filename> file in
				<filename>/var/run/openct</filename>.
				Without that file OpenCT will not work.
			</para>

			<para>
				<screen>
aj@simulacron:~/openct$ sbin/openct-control 
usage: openct-control [-d] [-f configfile] command
  -d   enable debugging; repeat to increase verbosity
  -f   specify config file (default /etc/openct.conf
  -h   display this message

Where command is one of:
init - initialize OpenCT
attach device ident - attach a hotplug device
shutdown - shutdown OpenCT
				</screen>
			</para>

			<para>
				FIXME: maybe run openct-control every time
				on bootup ?
			</para>
		</section>

		<section id="openct.files.init">
			<title>Init script to start openct</title>

			<para>
				On Debian systems install the init script
				like this: <screen>
# update-rc.d openct start 99 2 3 4 5 . stop 01 0 1 6 .
 Adding system startup for /etc/init.d/openct ...
   /etc/rc0.d/K01openct -> ../init.d/openct
   /etc/rc1.d/K01openct -> ../init.d/openct
   /etc/rc6.d/K01openct -> ../init.d/openct
   /etc/rc2.d/S99openct -> ../init.d/openct
   /etc/rc3.d/S99openct -> ../init.d/openct
   /etc/rc4.d/S99openct -> ../init.d/openct
   /etc/rc5.d/S99openct -> ../init.d/openct
#
				</screen>
			</para>

		</section>

		<section id="openct.files.linuxhp">
			<title>Linux with hotplugging</title>

			<para>
				If your kernel has hotplugging, you can
				configure your Linux, so it will launch
				the driver when a USB crypto token is plugged
				in (and it terminates when you unplug your key).
			</para>

			<para>
				If the file
				<filename>/proc/sys/kernel/hotplug</filename>
				exists, then your kernel supports hotplugging.
				If not, it does not (check CONFIG_HOTPLUG in
				your kernel configuration).
			</para>

			<para>
				If your Linux has no script
				<filename>/sbin/hotplug</filename> you can
				simply <screen>
ln -s /path/to/openct/sbin/hotplug.openct /sbin/htplug
				</screen>
			</para>
		</section>


		<section id="openct.files.sbinifdhandler">
			<title>sbin/ifdhandler - OpenCT device handler</title>

			<para>
				This app is called by openct-control to handle
				one device, e.g. a smart card reader or an USB
				token.
			</para>

			<para>
				<screen>
aj@simulacron:~/openct/bin$ ./ifdhandler 
usage: ifdhandler [-Hds] driver device socket
  -d   enable debugging; repeat to increase verbosity
  -H   hotplug device, monitor for detach
  -s   send error and debug messages to syslog
  -h   display this message
				</screen>
			</para>
		</section>

		<section id="openct.files.opencttool">
			<title>bin/openct-tool</title>

			<para>
				<screen>
aj@simulacron:~/openct/bin$ ./openct-tool 
usage: print-atr [-d] [-f configfile] [-r reader] command ...
  -d   enable debugging; repeat to increase verbosity
  -f   specify config file (default /etc/ifd.conf
  -r   specify index of reader to use
  -h   display this message

command: can be one of the following
 list  list all readers found
 atr   print ATR of card in selected reader
 wait  wait for card to be inserted
 mf    try to select ATR of card
				</screen>
			</para>
		</section>

		<section id="openct.files.openctconf">
			<title>etc/openct.conf</title>

			<para>
				<screen>
# Set debug level
debug	= 0;
#
# Enable hot plugging
hotplug	= yes;
#
# Path to ifdhandler
ifdhandler = /usr/sbin/ifdhandler;
#
# Statically configure non-hotplug aware readers here
reader towitoko {
	driver = towitoko;
	device = /dev/ttyS1;
};

#
# Hotplug IDs
driver	etoken {
	ids = {
		usb:0529/050c,
	};
};
driver	egate {
	ids = {
		usb:0973/0001,
	};
};
				</screen>
			</para>
		</section>

		<section id="openct.files.includes">
			<title>include/openct/</title>

			<para>
				<screen>
aj@simulacron:~/openct$ ls include/openct/
apdu.h    conf.h    driver.h  ifd.h      openct.h     protocol.h  socket.h
buffer.h  device.h  error.h   logging.h  pathnames.h  server.h    tlv.h
				</screen>
			</para>
		</section>

		<section id="openct.files.lib">
			<title>lib/libifd.so</title>

			<para>
				<screen>
aj@simulacron:~/openct$ /bin/ls lib/libifd.*    
lib/libifd.a   lib/libifd.so    lib/libifd.so.0.0.0
lib/libifd.la  lib/libifd.so.0
				</screen>
			</para>
		</section>

	</chapter>

	<chapter id="openct.ct-api">
		<title>Using OpenCT as CT-API driver</title>

		<para>
			Install and configure the directory
			<filename>/etc/openct.conf</filename> as discussed.
			Configure your CT-API application to load
			<filename>lib/ifd-ctapi.so</filename>.
		</para>

		<para>
			For example to use OpenCT with PC/SC Lite,
			configure <filename>/etc/reader.conf</filename>
			this way:
			<screen>
FIXME: 
add valid reader.conf entry to use
openct ifd-ctapi.so
			</screen>
		</para>

		<para>
			If your application does not support shared
			libraries, maybe you have better luck with the
			static library <filename>lib/ifd-ctapi.a</filename>.
			(This is completely untested.)
		</para>
	</chapter>

	<chapter id="openct.pcsc">
		<title>Using OpenCT as IfdHandler</title>

		<para>
			Install and configure the directory
			<filename>/etc/openct.conf</filename> as discussed.
			Configure your CT-API application to load
			<filename>lib/ifdhandler.so</filename>.
		</para>

		<para>
			For example to use OpenCT with PC/SC Lite,
			configure <filename>/etc/reader.conf</filename>
			this way:
			<screen>
FIXME: 
add valid reader.conf entry to use
openct ifdhandler.so
			</screen>
		</para>

	</chapter>

	<chapter id="openct.library">
		<title>Writing smart card applications using OpenCT</title>

		<para>
			OpenCT has a proprietary, but very easy to use
			interface. Take a look at the header files
			<filename>include/opensc/*.h</filename> and 
			the library <filename>lib/libopenct*</filename>.
		</para>

		<para>
			If your application uses autoconf, we made
			it easy for you to search for OpenCT and
			link with libopenct by shipping OpenCT with
			a pkg-config file:
			<filename>lib/pkg-config/libopenct.pc</filename>
		</para>

		<para>
			See the pkg-config man page for detailed information.
		</para>
	</chapter>

	<chapter id="openct.trouble">
		<title>Troubleshooting</title>

		<para>
			If something does not work, please join the OpenSC
			mailing list and ask for help. For details on the
			mailing list take a look at <ulink
				url="http://www.opensc.org/" />
		</para>

		<para>
			If you try to use a USB device, please try this:
			Do you have a <filename>/proc</filename> filesystem?
			This command should work:
			<prompt>ls /proc/sys</prompt>
		</para>

		<para>
			Is your kernel compiled with USB support? Does the
			USB support work? This command should list all
			USB devices:
			<prompt>lsusb</prompt>
		</para>

		<para>
			Is your kernel compiled with hotplugging support?
			This command give the same output on your system:
			<screen>
$ cat /proc/sys/kernel/hotplug 
/sbin/hotplug
$ 
			</screen>
		</para>

		<para>
			Do you have a hotplug script?
			This command should work:
			<prompt>ls /sbin/hotplug</prompt>
		</para>

		<para>
			Did you create the directory
			<filename>/var/run/openct</filename>? What files are in
			there? What are the file permissions?
			Try this command, it should work and give you a
			similar output:
			<screen>
$ ls -la /var/run/openct/
total 8
drwxr-xr-x    2 root     root         4096 2003-07-02 08:13 ./
drwxr-xr-x    8 root     root         4096 2003-07-02 08:13 ../
-rw-r--r--    1 root     root         1728 2003-07-02 08:13 status
$ 
			</screen>
			See the <link linkend="openct.security">security
			chapter</link> for details on file permissions
			of this directory.
		</para>

		<section id="openct.trouble.usb">
			<title>Problems with USB devices</title>
		<para>
			Are you using an USB smart card reader or
			USB crypto token? What is it's USB vendor and
			product id? <prompt>lsusb</prompt> will tell you.
		</para>

		<para>
			Is that product id listed in
			<filename>openct.conf</filename>? If not, please
			add it.
		</para>
		
		<para>
			If you have a file
			<filename>/etc/hotplug/usb.usermap</filename>, is the
			vendor and product id listed in that file?
			If not, add a line similar to the
			<link linkend="openct.install.withhp">install
			chapter</link>.
			The vendor ID is the second number, the product ID
			the third number.
		</para>
		
		<para>
			If that solves the problem, please let the OpenCT
			developers know, so we can improve the default
			configuration and documentation. You can reach
			us using the OpenSC developer mailing list at
			<email>opensc-devel@opensc.org</email>.
		</para>

		</section>
	</chapter>

	<chapter id="openct.security">
		<title>Security</title>

		<para>
			The default setting is not very secure: all users
			can access your smart card readers. Several processes
			can use the same smart card reader at the same time,
			but they always have to be owned by the same users.
			(FIXME: is it necessary to issue a LOCK command for
			this, or will it always work like this?)
		</para>

		<para>
			You can restrict access to smart card readers using
			OpenCT to one user with these
			commands:
			<screen>
$ chown user /var/run/openct
$ chmod 700 /var/run/openct
			</screen>
		</para>

		<para>
			You can also create a group, add users to that group
			and restrict access to smart card readers using OpenCT
			to that group with these commands:
			<screen>
$ chgrp group /var/run/openct
$ chmod 750 /var/run/openct
			</screen>
		</para>

		<para>
			In both cases root can still access the smart
			card readers. Replace <replaceable>user</replaceable>
			and <replaceable>group</replaceable> with the user
			and group of your choice.
		</para>

		<para>
			If you want all users to be able to access smart card
			readers using OpenCT:
			<screen>
$ chmod 755 /var/run/openct
			</screen>
		</para>
	</chapter>
</book>
